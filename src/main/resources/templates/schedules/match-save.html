<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{fragments/head :: headFragment}"></th:block>
    <link rel="stylesheet" th:href="@{/css/schedules/match-save.css}">
</head>
<body>
    <div class="container">
        <div class="page-title">
            <h1>경기 설정</h1>
        </div>

        <!-- 경기 정보 입력 폼 (새로 추가) -->
        <div class="match-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="match-date">경기 일자</label>
                    <input type="date" id="match-date" class="form-control" th:value="${saveMode eq 'update' ? #temporals.format(match.matchAt.atZoneSameInstant(T(java.time.ZoneId).of('Asia/Seoul')), 'yyyy-MM-dd', T(java.util.Locale).KOREAN) : ''}">
                </div>
                <div class="form-group">
                    <label for="match-time">경기 시간</label>
                    <input type="time" id="match-time" class="form-control" th:value="${saveMode eq 'update' ? #temporals.format(match.matchAt.atZoneSameInstant(T(java.time.ZoneId).of('Asia/Seoul')), 'HH:mm', T(java.util.Locale).KOREAN) : ''}">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="opponent-team">상대팀 이름</label>
                    <input type="text" id="opponent-team" class="form-control" placeholder="상대팀 이름 입력" th:value="${saveMode eq 'update' ? match.opponentName : ''}">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group location-group">
                    <label for="match-location">경기 장소</label>
                    <div class="location-input-container">
                        <input type="text" id="match-location" class="form-control location-input" placeholder="경기 장소 입력" th:value="${saveMode eq 'update' ? match.location : ''}" readonly>
                        <button id="search-location" class="btn map-search-btn">지도에서 검색</button>
                    </div>
                    <!-- 주소 표시 필드 추가 -->
                    <div class="location-address-container">
                        <input type="text" id="match-address" class="form-control location-address" placeholder="주소" th:value="${saveMode eq 'update' ? match.address : ''}" readonly>
                    </div>
                    <!-- 카카오맵 표시 영역 추가 -->
                    <div id="map-container" style="display:none;">
                        <div id="map" style="width:100%;height:300px;"></div>
                        <div class="map-search-box">
                            <input type="text" id="keyword" class="form-control" placeholder="강서 개화 축구장 등 검색">
                            <button id="search-keyword" class="btn">검색</button>
                        </div>
                    </div>

                    <input type="hidden" id="map-longitude" th:value="${saveMode eq 'update' ? match.longitude : ''}">
                    <input type="hidden" id="map-latitude" th:value="${saveMode eq 'update' ? match.latitude : ''}">
                </div>
            </div>
        </div>

        <!-- 선수 선택 영역 (새로 추가) -->
        <div class="player-selection-section">
            <div class="player-selection-header">
                <h3>출전 선수 선택</h3>
                <div class="player-actions">
                    <button id="add-guest-player" class="btn guest-player-btn">용병 추가</button>
                    <div class="player-count">
                        <span id="selected-player-count">0</span> / <span id="total-player-count">0</span> 명 선택됨
                    </div>
                </div>
            </div>
            <div class="player-list-container">
                <div class="player-list" id="player-list">
                    <!-- 선수 목록은 JS로 동적 생성됨 -->
                </div>
            </div>
        </div>

        <!-- 선수별 쿼터 참여 현황 섹션 추가 -->
        <div class="player-quarter-stats-section">
            <div class="stats-header">
                <h3>선수별 쿼터 참여 현황</h3>
                <button id="toggle-stats-view" class="btn toggle-btn">상세보기</button>
            </div>
            <div class="stats-container">
                <div class="stats-summary">
                    <div class="summary-item">
                        <span class="summary-label">총 포지션 배정</span>
                        <span class="summary-value" id="total-quarters">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">평균 쿼터</span>
                        <span class="summary-value" id="avg-quarters">0.0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">최다 쿼터</span>
                        <span class="summary-value" id="max-quarters">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">최소 쿼터</span>
                        <span class="summary-value" id="min-quarters">0</span>
                    </div>
                </div>
                <div class="player-quarter-table" id="player-quarter-table">
                    <div class="quarter-table-header">
                        <div>선수</div>
                        <div>1쿼터</div>
                        <div>2쿼터</div>
                        <div>3쿼터</div>
                        <div>4쿼터</div>
                        <div>총 쿼터</div>
                    </div>
                    <!-- 선수별 쿼터 현황 테이블은 JS로 동적 생성됨 -->
                    <div id="player-quarter-body"></div>
                </div>
            </div>
        </div>

        <!-- 쿼터 선택 탭 -->
        <div class="quarter-tabs">
            <button class="quarter-tab active" data-quarter="1">1쿼터</button>
            <button class="quarter-tab" data-quarter="2">2쿼터</button>
            <button class="quarter-tab" data-quarter="3">3쿼터</button>
            <button class="quarter-tab" data-quarter="4">4쿼터</button>
        </div>

        <!-- 포메이션 선택 -->
        <div class="formation-select-box">
            <label for="formation-select">포메이션</label>
            <select id="formation-select" class="formation-select">
            </select>
            <button id="auto-position-btn" class="btn auto-position-btn">포지션 자동 배정</button>
        </div>

        <!-- 축구장 영역 (넓게) -->
        <div class="field-wrapper">
            <div class="field">
                <!-- 안내 메시지 (축구장 내부 상단) -->
                <div class="field-instruction-inner">
                    <p>포지션을 터치하여 선수를 선택하세요</p>
                </div>
                <!-- JS로 동적 생성됨 -->
            </div>
        </div>
        
        <!-- 저장 버튼 -->
        <div class="save-formation">
            <button class="btn save-btn">경기 정보 저장</button>
        </div>

        <!-- 선수 할당 모달 추가 -->
        <div class="player-select-modal modal-container" id="player-select-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>선수 선택</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-player-list">
                    <!-- 선택된 선수 목록만 표시됨 (JS로 동적 생성) -->
                </div>
            </div>
        </div>

        <!-- 용병 추가 모달 -->
        <div class="guest-player-modal modal-container" id="guest-player-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>용병 추가</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="guest-player-name">이름</label>
                        <input type="text" id="guest-player-name" class="form-control" placeholder="용병 이름 입력">
                    </div>
                    <div class="form-group modal-actions">
                        <button id="add-guest-player-btn" class="btn add-guest-btn">추가</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 포지션 자동 배정 모달 -->
        <div class="auto-position-modal modal-container" id="auto-position-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>포지션 자동 배정</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="auto-position-info">
                        <p>• 플레이어가 선호하는 포지션에 우선 배정해 줍니다.</p>
                        <p>• 선호하는 포지션이 겹치는 선수가 많은 경우, 랜덤으로 배정됩니다.</p>
                        <p>• 선호하는 포지션에 골키퍼(GK)가 포함된 경우, 골키퍼에만 배정됩니다.</p>
                        <p>• 용병보다 팀의 멤버에게 많은 쿼터수를 배정해 줍니다.</p>
                        <p>• 세부 조정이 필요할 경우, 포지션을 클릭하여 수동으로 변경해야 합니다.</p>
                    </div>
                    <div class="modal-actions">
                        <button id="generate-position-btn" class="btn generate-btn">자동 배정 생성</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <th:block th:replace="~{fragments/nav :: navFragment}"></th:block>

    <template id="place-item-template">
        <div class="place-item">
            <div class="place-item-inner">
                <div class="place-marker"></div>
                <div class="place-info">
                    <h5 class="place-name"></h5>
                    <span class="place-category"></span>
                    <span class="place-address"></span>
                    <span class="place-road-address" style="display: none;"></span>
                    <span class="place-phone" style="display: none;"></span>
                </div>
                <button class="select-place-btn">선택</button>
            </div>
        </div>
    </template>

    <template id="place-info-window-template">
        <div class="place-info-window">
            <div class="place-info-name"></div>
            <div class="place-info-address"></div>
        </div>
    </template>

    <template id="player-card-template">
        <div class="player-card">
            <div class="player-card-number"></div>
            <div class="player-card-name"></div>
        </div>
    </template>

    <th:block th:replace="~{schedules/position-template :: positionTemplateFragment}"></th:block>

    <input type="hidden" id="save-mode" th:value="${saveMode}">
    <input type="hidden" id="match-id" th:value="${saveMode eq 'update' ? match.id : ''}">

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=33f6142573a63b0f99ad87db952a8186&libraries=services"></script>
    <script type="module" th:src="@{/js/schedules/match-save.js}" defer></script>
</body>
</html> 